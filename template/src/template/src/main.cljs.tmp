(ns {{project}}.main
  {:shadow.css/include
   ["{{project-folder}}/main.css"]}
  (:require
   ["react-dom/client" :refer [createRoot]]
   [goog.string :refer [format]]
   [shadow.css :refer [css]]
   [helix.core :refer [$ defnc provider <>]]
   [helix.dom :as d]
   [helix.hooks :as hooks]
   [toddler.app :as app]
   [toddler.ui :as ui]
   [toddler.i18n.time]
   [toddler.core :as toddler]
   [toddler.popup :as popup]
   [toddler.layout :as layout]
   [toddler.ui.components :refer [components]]
   [toddler.ui.css :as ui.css]
   [toddler.notifications :as notifications]
   [toddler.md.lazy :as md]
   [toddler.material.outlined :as outlined]
   [toddler.fav6.brands :as brands]
   [toddler.window :refer [wrap-window-provider]]
   [toddler.router :as router]
   [{{project}}.docs :refer [Docs]]))

(defonce root (atom nil))

(def goku "https://giphy.com/embed/fmMdxlVwsCmTtA4V6a")

(defnc GiphyEmbed [{:keys [src width height]}]
  (d/div
   {:dangerouslySetInnerHTML
    #js {:__html (format
                  "<iframe src=\"%s\" width=\"%s\" height=\"%s\" style=\" \" frameBorder=\"0\" class=\"giphy-embed\" allowFullScreen></iframe><p><a href=\"https://giphy.com/gifs/studiosoriginals-2yLNN4wTy7Zr8JSXHB\"></a></p>"
                  src width height)}}))

(defnc actions
  {:wrap [(ui/forward-ref)]}
  [_ _ref]
  (let [{go-to :go} (router/use-navigate)
        theme (toddler/use-theme)
        on-theme-change (toddler/use-theme-change)]
    (d/div
     {:className (css :flex
                      :items-center
                      :h-10
                      :flex-row-reverse
                      :pr-1
                      :box-border
                      ["& .wrapper"
                       :items-center :flex :items-center {:font-size "24px"} :mr-4
                       :cursor-pointer :color-inactive]
                      ["& .wrapper:first-child" :mr-0]
                      ["& .tooltip-popup-area:hover" :color-normal])}
     (d/div
      {:className "wrapper"}
      ($ ui/tooltip {:message "Change theme"}
         (d/div
          {:on-click (fn []
                       (on-theme-change
                        (case theme
                          ("dark" 'dark) "light"
                          ("light" 'light) "dark"
                          "light")))}
          (if (= "dark" theme)
            ($ outlined/light-mode)
            ($ outlined/dark-mode)))))
     (d/div
      {:className "wrapper"}
      ($ ui/tooltip {:message "API Docs"}
         ($ outlined/info
            {:on-click (fn []
                         (go-to "/docs/"))}))))))

(defnc Greeting
  {:wrap [(router/wrap-rendered ::greeting)
          (router/wrap-link
           ::router/ROOT
           [{:id ::greeting
             :segment "greeting"
             :landing 10}])]}
  []
  (let [{window-width :width
         window-height :height} (toddler/use-window-dimensions)
        [_greeting {greeting-height :height greeting-width :width}] (toddler/use-dimensions)
        scale 0.7
        layout (toddler/use-layout)]
    (case layout
      :mobile
      ($ ui/column
         {:align :center}
         ($ ui/row
            {:align :explode
             :className (css :pl-4 :pr-2 {:height "50px"})}
            (d/h1 "Toddler")
            ($ actions))
         ($ ui/simplebar
            {:style {:width window-width
                     :height (- window-height 80)}}
            ($ ui/row
               {:align :center
                :className (css
                            ["& .message" {:max-width "300px"}]
                            ["& hr" :mt-6 :mb-2]
                            ["& h4" {:margin-top "8px !important"}]
                            ["& h1" :mb-6 {:font-size "32px"}]
                            ["& p" :mt-2 {:font-size "12px"}]
                            ["& a" {:color "var(--link-color)" :font-weight "600"}]
                            ["& .toddler-markdown" :my-6 #_{:margin-bottom "8px !important"}])}
               (d/div
                {:className "message"}

                ($ md/watch-url {:url "docs/greeting.md"})))
            ($ ui/row
               {:align :center}
               (d/div
                {:className (css :border :border-normal :rounded-lg :overflow-hidden)}
                ($ GiphyEmbed {:src goku
                               :width (* 265 scale)
                               :height (* scale 200)})))))
      ;;
      ($ ui/row
         {:align :center
          :className (css :items-center :w-full :h-full)}
         (d/div
          {:ref #(reset! _greeting %)
           :style {:width (min window-width 400)
                   :height (min (- window-height 100) 650)}
           :className (css :border :border-normal
                           :rounded-lg :relative :bg-normal+)}
          ($ ui/row
             {:align :explode
              :className (css :pt-8 :px-8 :pb-2)}
             (d/h1 "Toddler")
             ($ actions))
          ($ ui/simplebar
             {:style {:width greeting-width
                      :height (- greeting-height 88)}}
             ($ ui/row
                {:align :center
                 :className (css
                             ["& .message" {:max-width "300px"}]
                             ["& hr" :mt-6 :mb-2]
                             ["& h4" {:margin-top "8px !important"}]
                             ["& h1" :mb-6 {:font-size "32px"}]
                             ["& p" :mt-2 {:font-size "12px"}]
                             ["& a" {:color "var(--link-color)" :font-weight "600"}]
                             ["& .toddler-markdown" :my-6 #_{:margin-bottom "8px !important"}])}
                (d/div
                 {:className "message"}
                 ($ md/watch-url {:url "/docs/greeting.md"})))
             ($ ui/row
                {:align :center}
                (d/div
                 {:className (css :border :border-normal :rounded-lg :overflow-hidden :mb-8)}
                 ($ GiphyEmbed {:src goku
                                :width (* 265 scale)
                                :height (* scale 200)})))))))))

(goog-define MD_BASE "")
(goog-define MD_REFRESH_PERIOD 3000)
(goog-define ROUTER_BASE "")

(defnc App
  {:wrap [(router/wrap-landing "/" false)
          (toddler/wrap-theme ::theme)
          (md/wrap-show {:className ui.css/$md})
          (md/wrap-base MD_BASE)
          (md/wrap-refresh MD_REFRESH_PERIOD)
          (notifications/wrap-store {:class ui.css/$store})
          (popup/wrap-container)
          (wrap-window-provider)
          (ui/wrap-ui components)
          (router/wrap-router ROUTER_BASE)]}
  []
  (let [[locale set-locale!] (hooks/use-state :en)
        app-mobile (toddler/use-window-width-test < 600)
        docs-mobile (toddler/use-window-width-test < 1000)]
    (provider
     {:context app/locale
      :value locale}
     (<>
      (provider
       {:context app/layout
        :value (if app-mobile :mobile :desktop)}
       ($ Greeting))
      (provider
       {:context app/layout
        :value (if docs-mobile :mobile :desktop)}
       ($ Docs))))))

(defn ^:dev/after-load start! []
  (let [target ^js (.getElementById js/document "app")]
    (when-not @root
      (reset! root ^js (createRoot target)))
    (.render ^js @root ($ App))))
